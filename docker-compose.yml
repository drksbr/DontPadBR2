services:
  # Next.js application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "4000:3000"
    environment:
      - NODE_ENV=production
      - CONNECTION_STRING=ys://ysweet:8080
    volumes:
      - app-data:/app/.data
    depends_on:
      - ysweet
    restart: unless-stopped
    networks:
      - dontpad-network

  # Y-Sweet collaboration server
  ysweet:
    build:
      context: .
      dockerfile: Dockerfile.ysweet
    ports:
      - "4001:8080"
    environment:
      - URL_PREFIX=${YSWEET_URL_PREFIX:-wss://api.dontpad.com.br}
    volumes:
      - ysweet-data:/data
    restart: unless-stopped
    networks:
      - dontpad-network

  # Redis (recomendado para produção do LiveKit)
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - dontpad-network

  # LiveKit Server
  livekit:
    image: livekit/livekit-server:latest
    command: ["--config", "/etc/livekit.yaml"]
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - dontpad-network
    ports:
      # Sinalização (HTTP/WS). No seu cenário, isso será proxied pelo NPM.
      - "7880:7880/tcp"

      # Fallback TCP do WebRTC
      - "7881:7881/tcp"

      # Mídia WebRTC (UDP) - faixa grande recomendada
      - "50000-60000:50000-60000/udp"

  # TURN server (coturn)
  coturn:
    image: instrumentisto/coturn:latest
    restart: unless-stopped
    networks:
      - dontpad-network
    ports:
      # TURN UDP
      - "3478:3478/udp"

      # TURN TCP (opcional, útil em redes que bloqueiam UDP)
      - "3478:3478/tcp"

      # TURN TLS (opcional; requer certificado)
      - "5349:5349/tcp"

      # Faixa de relay do TURN (UDP) - você deve liberar no firewall
      - "50000-60000:50000-60000/udp"
    environment:
      # IP público real do servidor TURN (mesmo do LiveKit, aqui 45.162.145.14)
      - TURN_EXTERNAL_IP=${LIVEKIT_PUBLIC_IP}

      # Credenciais estáticas (simples e funcional). Troque por valores fortes.
      - TURN_USER=${TURN_USER:-turnuser}
      - TURN_PASSWORD=${TURN_PASSWORD:-turnpassforte}

      # Domínio (apenas para log/realm)
      - TURN_REALM=${TURN_REALM:-dontpad.com.br}
    volumes:
      - ./turnserver.conf:/etc/coturn/turnserver.conf:ro
      # Se você for habilitar TLS no TURN (5349), monte certificados:
      # - ./certs/fullchain.pem:/etc/coturn/certs/fullchain.pem:ro
      # - ./certs/privkey.pem:/etc/coturn/certs/privkey.pem:ro

networks:
  dontpad-network:
    driver: bridge

volumes:
  ysweet-data:
  app-data:
  redis-data:
